PE.DataAccess=new function(){this.getVehicleOffers=function(callback,vin){var dataFromMonroney={};PE.cashHeight=0;var ccode=cllc.context.get("ccode")||Vehicles.getCcode(cllc.context.get()),llp=cllc.context.get("llp")||Vehicles.getLLP(cllc.context.get()),selectOptions=PE.isOfferState&&PE.offerStateValue.selectedOptions?"&options="+PE.offerStateValue.selectedOptions.split(" ").join(",")+"&stdConfig=N":"",request=new cllc.request.ajax(String.format("/hostd/incentives/getvehicleoffers.json?zip={0}&ccode={1}&llp={2}{3}",cllc.context.get("zipcode"),ccode,llp,selectOptions));if(request.responseType="json",request.onsuccess=function(response){if("SUCCESS"==response.result.result){var purchases=response.result.data.purchases,offerData={};if(PE.vehicle={},PE.offerData=PE.offerData||{},PE.offerData.buy=PE.offerData.buy||{},PE.offerData.lease=PE.offerData.lease||{},PE.vehicle.destination=response.result.data.vehicle.desCharge||0,PE.vehicle.vehiclePrice=PE.isOfferState&&PE.offerStateValue.msrp?Number(PE.offerStateValue.msrp):response.result.data.vehicle.basePrice,PE.vehicle.configuredPrice=PE.isOfferState&&PE.offerStateValue.msrp?Number(PE.offerStateValue.msrp):response.result.data.vehicle.configuredPrice,dataFromMonroney.basePrice&&(PE.vehicle.vehiclePrice=dataFromMonroney.basePrice),dataFromMonroney.destinationCharge&&(PE.vehicle.destination=dataFromMonroney.destinationCharge),dataFromMonroney.totalPrice&&(PE.vehicle.configuredPrice=dataFromMonroney.totalPrice),PE.downPaymentOverride=!!PE.isOfferState,PE.downPaymentPercent=PE.isOfferState&&PE.offerStateValue.downPayPercent?PE.offerStateValue.downPayPercent:Number(PE.downPaymentPercent)||.1,PE.downPaymentPercentActual=PE.isOfferState&&PE.offerStateValue.downPaymentPercentActual?PE.offerStateValue.downPaymentPercentActual:PE.downPaymentPercentActual?PE.downPaymentPercentActual:PE.downPaymentPercent,PE.vehicle.otherCapCosts=PE.isOfferState&&PE.offerStateValue.selectedOptionsTotal?PE.offerStateValue.selectedOptionsTotal:PE.BusinessLogic.totalOptionsCost(response.result.data.vehicle),dataFromMonroney.optionsPrice&&(PE.vehicle.otherCapCosts=dataFromMonroney.optionsPrice),1==purchases.length&&"cash"==purchases[0].type||0==purchases.length){var apr_terms=0<response.result.data.incentives.length&&[{duration:72,offer:{type:"custom_apr",rateIncentive:{rate:6.47}}},{duration:60,offer:{type:"custom_apr",rateIncentive:{rate:6.47}}},{duration:48,offer:{type:"custom_apr",rateIncentive:{rate:6.47}}},{duration:36,offer:{type:"custom_apr",rateIncentive:{rate:6.47}}},{duration:24,offer:{type:"custom_apr",rateIncentive:{rate:6.47}}}];if(offerData.buy={},offerData.buy.payment=PE.isOfferState&&PE.offerStateValue.buyMonthlyPayment?PE.offerStateValue.buyMonthlyPayment:0,offerData.buy.term=PE.isOfferState&&PE.offerStateValue.buyTerm?PE.offerStateValue.buyTerm:apr_terms&&apr_terms[0].duration,offerData.buy.rate=PE.isOfferState&&PE.offerStateValue.buyRate?PE.offerStateValue.buyRate:apr_terms&&apr_terms[0].offer.rateIncentive.rate,offerData.buy.disclaimer="This rate is for estimation purposes only. You may not be able to finance your vehicle at this rate. See dealer for details.",offerData.buy.offerType="custom_apr",offerData.buy.cash=0,offerData.buy.tradeInValue=PE.isOfferState&&PE.offerStateValue.tradeInValue?PE.offerStateValue.tradeInValue:PE.offerData.buy.tradeInValue||0,offerData.buy.dealerDiscount=PE.isOfferState&&PE.offerStateValue.dealerDiscount?PE.offerStateValue.dealerDiscount:PE.offerData.buy.dealerDiscount||0,offerData.buy.finance=0,offerData.buy.overRide=!0,offerData.buy.termtype="custom_apr",offerData.cash={},offerData.cash.incentives_object={},offerData.cash.incentives_object.incentives=[],offerData.buy.incentives_object={},offerData.buy.incentives_object.custom_apr={},offerData.buy.incentives_object.custom_apr.incentives=[],PE.isOfferState&&PE.offerStateValue.hasOwnProperty("buyOfferType")){var type="custom_apr"==PE.offerStateValue.buyOfferType?"radio_user_rate":"radio_standard_rate";cllc.context.set("rate_type",type),offerData.buy.user_rate="radio_user_rate"===cllc.context.get("rate_type")?PE.offerStateValue.buyRate:6.47}else!cllc.context.get("rate_type")&&cllc.context.set("rate_type","radio_user_rate"),offerData.buy.user_rate=cllc.context.get("rate_value")?cllc.context.get("rate_value"):6.47;offerData.buy.terms=apr_terms&&PE.BusinessLogic.getBuyTerms(apr_terms)}else for(var i=0;i<purchases.length;i++){var lease_terms=[];apr_terms=[];if("apr"==purchases[i].type){apr_terms=purchases[i].terms.sort(function(a,b){return a.offer.basePayment-b.offer.basePayment}),offerData.buy={},offerData.buy.payment=PE.isOfferState&&PE.offerStateValue.buyMonthlyPayment?PE.offerStateValue.buyMonthlyPayment:apr_terms[0].offer.basePayment,offerData.buy.term=PE.isOfferState&&PE.offerStateValue.buyTerm?PE.offerStateValue.buyTerm:apr_terms[0].duration,offerData.buy.rate=PE.isOfferState&&PE.offerStateValue.buyRate?PE.offerStateValue.buyRate:apr_terms[0].offer.rateIncentive.rate,offerData.buy.disclaimer="This rate is for estimation purposes only. You may not be able to finance your vehicle at this rate. See dealer for details.",offerData.buy.rateIncentiveId=null!==apr_terms[0].offer.rateIncentive?apr_terms[0].offer.rateIncentive.incid:0,offerData.buy.offerType=PE.isOfferState&&PE.offerStateValue.buyOfferType?PE.offerStateValue.buyOfferType:response.result.data.incentives[Number(offerData.buy.rateIncentiveId)-1].type,offerData.buy.overRide=!1,offerData.buy.termtype=apr_terms[0].offer.type,offerData.buy.incentives_object={},cllc.context.set("offer_type",offerData.buy.offerType),PE.isDebug&&(console.log("PE.offerStateValue.buyOfferType : "+PE.offerStateValue.buyOfferType),console.log(offerData.buy.offerType));for(var tc=0;tc<apr_terms.length;tc++){var term_type=apr_terms[tc].offer.type;offerData.buy.incentives_object[term_type]={id:apr_terms[tc].offer.type},offerData.buy.incentives_object[term_type].incentives_array=null!==apr_terms[tc].offer.additiveIncentives?apr_terms[tc].offer.additiveIncentives.additiveIncentives:[]}for(var inc in offerData.buy.incentives_object){(term_type=offerData.buy.incentives_object[inc]).incentives=[];for(var j=0;j<term_type.incentives_array.length;j++){var incid=parseFloat(term_type.incentives_array[j])-1;term_type.incentives.push(response.result.data.incentives[incid])}}offerData.buy.cash=PE.BusinessLogic.totalCashIncentives(offerData.buy.incentives_object[apr_terms[0].offer.type].incentives),offerData.buy.tradeInValue=PE.isOfferState&&PE.offerStateValue.tradeInValue?PE.offerStateValue.tradeInValue:PE.offerData.buy.tradeInValue||0,offerData.buy.dealerDiscount=PE.isOfferState&&PE.offerStateValue.dealerDiscount?PE.offerStateValue.dealerDiscount:PE.offerData.buy.dealerDiscount||0,offerData.buy.finance=0;var ratetype="custom_apr"==offerData.buy.offerType||"cash_allowance"==offerData.buy.offerType?"radio_user_rate":"radio_standard_rate";cllc.context.set("rate_type",ratetype),offerData.buy.user_rate="radio_user_rate"===ratetype?offerData.buy.rate:"6.47",PE.isDebug&&(console.log("ratetype : "+ratetype),console.log(offerData.buy.offerType),console.log("Parse Offers -> PE offerType : "+cllc.context.get("offer_type"))),offerData.buy.terms=PE.BusinessLogic.getBuyTerms(apr_terms,response.result.data.incentives)}else if("lease"==purchases[i].type){lease_terms=purchases[i].terms.sort(function(a,b){return a.offer.basePayment-b.offer.basePayment}),offerData.lease={},offerData.lease.payment=PE.isOfferState&&PE.offerStateValue.leaseMonthlyPayment?PE.offerStateValue.leaseMonthlyPayment:lease_terms[0].offer.basePayment,offerData.lease.term=PE.isOfferState&&PE.offerStateValue.leaseTerm?PE.offerStateValue.leaseTerm:lease_terms[0].duration,offerData.lease.rate=PE.isOfferState&&PE.offerStateValue.leaseRate?PE.offerStateValue.leaseRate:lease_terms[0].offer.rateIncentive.rate,offerData.lease.residual=PE.isOfferState&&PE.offerStateValue.residual?PE.offerStateValue.residual:lease_terms[0].offer.residualIncentive.rate,offerData.lease.mileage=PE.isOfferState&&PE.offerStateValue.mileage?PE.offerStateValue.mileage:lease_terms[0].offer.residualIncentive.mileage,offerData.lease.disclaimer="This lease rate is for estimation purposes only. You may not be able to lease your vehicle at this rate.",offerData.lease.rateIncentiveId=null!==lease_terms[0].offer.rateIncentive?lease_terms[0].offer.rateIncentive.incid:0,offerData.lease.offerType=response.result.data.incentives[Number(offerData.lease.rateIncentiveId)-1].type,offerData.lease.termtype=lease_terms[0].offer.type,offerData.lease.incentives_object={};for(tc=0;tc<lease_terms.length;tc++){term_type=lease_terms[tc].offer.type;offerData.lease.incentives_object[term_type]={id:lease_terms[tc].offer.type},offerData.lease.incentives_object[term_type].incentives_array=null!==lease_terms[tc].offer.additiveIncentives?lease_terms[tc].offer.additiveIncentives.additiveIncentives:[]}for(var inc in offerData.lease.incentives_object){(term_type=offerData.lease.incentives_object[inc]).incentives=[];for(j=0;j<term_type.incentives_array.length;j++){incid=parseFloat(term_type.incentives_array[j])-1;term_type.incentives.push(response.result.data.incentives[incid])}}offerData.lease.cash=PE.BusinessLogic.totalCashIncentives(offerData.lease.incentives_object[lease_terms[0].offer.type].incentives),offerData.lease.tradeInValue=PE.isOfferState&&PE.offerStateValue.tradeInValue?PE.offerStateValue.tradeInValue:PE.offerData.lease.tradeInValue||0,offerData.lease.dealerDiscount=PE.isOfferState&&PE.offerStateValue.dealerDiscount?PE.offerStateValue.dealerDiscount:PE.offerData.lease.dealerDiscount||0,offerData.lease.finance=0,offerData.lease.terms=PE.BusinessLogic.getLeaseTerms(lease_terms,response.result.data.incentives)}else if("cash"==purchases[i].type){offerData.cash={},offerData.cash.incentives_object={},offerData.cash.incentives_object.incentives=[],offerData.cash.incentives_object.incentives_array=null!==purchases[i].terms[0].offer.additiveIncentives?purchases[i].terms[0].offer.additiveIncentives.additiveIncentives:[];for(j=0;j<offerData.cash.incentives_object.incentives_array.length;j++){incid=parseFloat(offerData.cash.incentives_object.incentives_array[j])-1;offerData.cash.incentives_object.incentives.push(response.result.data.incentives[incid])}}}PE.isOfferState&&PE.offerStateValue.downPayment?(PE.downPayment=PE.offerStateValue.downPayment,PE.BusinessLogic.downPayment(PE.downPayment)):PE.BusinessLogic.downPayment(-1),PE.offerData=offerData,callback(offerData)}else{var errorObject={};"false"==PE.printView?PE.UIController.Markup.BuyLeaseColumns.render(errorObject):PE.UIController.Markup.BuyLeaseColumnsPrint.render(errorObject)}"undefined"!=typeof s&&(s.abort=0),setTimeout(function(){var overlay_page="payment-calculator";parent.window&&(overlay_page=-1<parent.window.location.pathname.indexOf("/build#")||-1<parent.window.location.pathname.indexOf("/bmo")?"build-price":parent.window.cllc.context.get("pageName"));var context={"overlay-page":overlay_page,vehicle:cllc.context.get("vehicle"),trim:cllc.context.get("trim"),year:cllc.context.get("year")},modelCode=Vehicles.getModelYearCode(cllc.context.get()).substr(-2);DATALAYER.set({vehicle:DATALAYER.getVehicleModel(modelCode),trim:cllc.context.get("trim").replace(/_/g,"-")}),$(".finance-options").attr("data-context",JSON.stringify(context)),DATALAYER.pageTrack("pe-results")},100)},request.onerror=function(){var errorObject={};"false"==PE.printView?PE.UIController.Markup.BuyLeaseColumns.render(errorObject):PE.UIController.Markup.BuyLeaseColumnsPrint.render(errorObject)},vin){var monroneyReq=function(vin){var request,url="/monroney/MonroneyXMLServlet?Vin="+vin;return(request=new cllc.request.ajax(url)).responseType="xml",request}(vin);monroneyReq.send(),monroneyReq.onsuccess=function(resp){var $response=$(resp);0<$response.find("BASEPRICE").length&&(dataFromMonroney.basePrice=Number($response.find("BASEPRICE").text().trim())),0<$response.find("DESTCHARGE").length&&(dataFromMonroney.destinationCharge=Number($response.find("DESTCHARGE").text().trim())),0<$response.find("TOTALPRICE").length&&(dataFromMonroney.totalPrice=Number($response.find("TOTALPRICE").text().trim())),dataFromMonroney.optionsPrice=dataFromMonroney.totalPrice-(dataFromMonroney.basePrice+dataFromMonroney.destinationCharge),request.send()},monroneyReq.onerror=function(){request.send()}}else request.send()},this.toString=function(){return"[object PE.DataAccess]"}};